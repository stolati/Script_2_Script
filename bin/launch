#!/usr/bin/env bash
set -eu

if [[ -z "${script2script_path:-}" ]]; then
  echo "Profile not loaded"
  echo ". profile"
  exit 1
fi

refs="$script2script_path/refs"
input="$script2script_path/input"
output="$script2script_path/output"
tmp="$script2script_path/tmp"

launch_exe="$0"

command="${1:-}"
shift || true

case "$command" in

  test) #launch main with a test
    testNum="${1:-}"

    if [[ $testNum = "all" ]] ; then
      i=1 ; while [[ $i -lt 48 ]]; do
        $launch_exe test $i || true
        let i+=1
        read
      done
    fi

    listTests(){ #<filtre>
      ls "$script2script_path/files_tests" | grep '.py$' | grep "${1:-}" | head -1
    }
    file="$(listTests "$testNum")"
    "$script2script_path/script2script/main.py" "$script2script_path/files_tests/$file"
  ;;
  compile)
    pyjscompile="$refs/Pyjamas/bin/pyjscompile"
    pyjampiler="$refs/Pyjamas/bin/pyjampiler"
    pyjsbuild="$refs/Pyjamas/bin/pyjsbuild"
    python "$pyjsbuild" \
      --output="$output/main.js" \
      "$input/main.py"

  ;;
  init)
    mkdir -p "$refs"

    git_pull(){ #<git_path> <dir_name>
      typeset git_path="$1" dir_name="$2"
      [[ -d "$refs/$dir_name" ]] || git clone "$git_path" "$refs/$dir_name"

      echo "Pulling $dir_name"
      (
        cd "$refs/$dir_name"
        git pull
      )
    }
    mercurial_pull(){ #<mercurial_path> <dir_name>
      typeset merc_path="$1" dir_name="$2"
      [[ -d "$refs/$dir_name" ]] || hg clone "$merc_path" "$refs/$dir_name"
      echo "Pulling $dir_name"
      (
        cd "$refs/$dir_name"
        #TODO search for update mercurial stuffs, I don't know how to do
        #hg update --insecure
      )
    }

    echo "Pulling script2script from github"
    ( cd "$script2script_path" ; git pull ; )

    git_pull git://pyjs.org/git/pyjamas.git Pyjamas
    git_pull http://git.nuitka.net/Nuitka.git Nuitka
    git_pull git://gitorious.org/shedskin/mainline.git Shedskin
    mercurial_pull https://bitbucket.org/pypy/pypy Pypy
    mercurial_pull https://mock.googlecode.com/hg mock

    ( cd "$refs/Pyjamas" ; python bootstrap.py ; )

  ;;

  tests) #launch the unittest
    (
      name="test*${1:-}*.py"
      cd "$script2script_path/test" #change in case of access by absolute
      python -m unittest discover -s "$script2script_path/test" -v -p "$name"

    )
  ;;

  pylint) #launch pylint on the code
   pylint --rcfile="$script2script_path/pylint.conf" "$script2script_path/script2script" "$script2script_path/code/test"
   #TODO idea is to use the -e arguments
   #TODO use -d instead, some errors are no worth using

  ;;
  list)
    find "$script2script_path/script2script" "$script2script_path/test" -name '*.py' | grep -v __init__
  ;;

  todo)
    (
      cd "$script2script_path"
      find script2script test -type f | xargs grep --color TODO
    )
  ;;

  *)
    echo "$launch_exe init #download/pull the git repository"
    echo "$launch_exe test <num> #launch main with a test"
    echo "$launch_exe tests [name] #launch unittest modules"
    echo "$launch_exe pylint #launch pylint on all the files"
    echo "$launch_exe list #list python files in the project"
    echo "$launch_exe todo #return a list of all the todo in files"
  ;;

esac


#how I got rhino
#wget ftp://ftp.mozilla.org/pub/mozilla.org/js/rhino1_7R3.zip #and here I got js.jar

#TODO I can use the Pyjamaas/pyjs/tests as my own tests

#__EOF__

